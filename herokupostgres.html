<script type="text/x-red" data-template-name="PGConfig">
  <div class="form-row">
    <label for="node-config-input-name"><i class="fa fa-tag"></i>Name</label>
    <input type="text" id="node-config-input-name">
  </div>

  <div class="form-row">
   <label for="node-config-input-dbconn"><i class="fa fa-server"></i>Connection Details</label>
   <input type="text" id="node-config-input-dbconn">
   <input type="hidden" id="node-config-input-dbconnFieldType">
  </div>

  <div id="connectionvalues" style="display: none;">
    <div class="form-row">
      <label for="node-config-input-username"></i>Username</label>
      <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
      <label for="node-config-input-password"></i>Password</label>
      <input type="text" id="node-config-input-password">
    </div>
    <div class="form-row">
      <label for="node-config-input-host"></i>Host</label>
      <input type="text" id="node-config-input-host">
    </div>
    <div class="form-row">
      <label for="node-config-input-port"></i>Port</label>
      <input type="text" id="node-config-input-port">
    </div>
    <div class="form-row">
      <label for="node-config-input-database"></i>Database</label>
      <input type="text" id="node-config-input-database">
    </div> 
  </div>

  <div id="connectionobject" style="display: none;">
    <div class="form-row">
      <label for="node-config-input-connobj"></i>Connection Object</label>
      <input type="text" id="node-config-input-connobj">
    </div>
  </div>
</script>



<script type="text/javascript">
  RED.nodes.registerType('PGConfig', {
    category: "config",
    defaults: {
      name: {value: ""},
      dbconnFieldType: {}
    },
    credentials: {
      dbconn: {type:"text"},  
      username: {type:"text"},
      password: {type:"password"},
      host: {type:"text"},
      port: {type:"text"},
      database: {type:"text"},
      connobj: {type:"text"}
    },
    label: function () {
      if (!this.name) {
        this.name = "Database Connection";
      }
      return this.name;
    },
    oneditprepare: function () {
      $("#node-config-input-dbconn").typedInput({
        default: 'DATABASE_URL',
        types: [
          {value:"DATABASE_URL", label:"$DATABASE_URL", hasValue:false},
          {value:"urlstring", label:"URL string "},
          'env', 
          {value:"values", label:"separate values", hasValue:false}, 
          {value:"conn", label:"connection object", hasValue:false} 
        ],
        typeField: $("#node-config-input-dbconnFieldType")
      });
      $("#node-config-input-dbconn").on('change', function(event, type, value) {
        if (type == "values"){
          document.getElementById('connectionvalues').style.display = "block"
        } else if (type != "values") {
          document.getElementById('connectionvalues').style.display = "none"
        }
        if (type == "conn"){
          document.getElementById('connectionobject').style.display = "block"
        } else if (type != "conn") {
          document.getElementById('connectionobject').style.display = "none"
        }
      });
      $("#node-config-input-connobj").typedInput({
        type:"json",
        types:["json"]
      });
    },
    oneditsave: function () {
      console.log(this.credentials)
    }
  }); 
</script>


<script type="text/x-red" data-template-name="Postgres">
  <div class="form-row">
    <label for="node-input-name"><i class="icon-tag"></i>Name</label>
    <input type="text" id="node-input-name"</div>
  <div class="form-row">
    <label for="node-input-PGConfig"><i class="fa fa-server"></i>Server</label>
    <input type="text" id="node-input-PGConfig">
  </div>
  <div class="form-row">
    <label for="node-input-output" style="width: auto;">Receive Output</label>
    <input type="checkbox" id="node-input-output" style="display: inline-block; width: auto; vertical-align: top;">

  </div>
  <div class="form-row" style="position: relative; margin-bottom: 0px;">
    <label for="node-input-query"><i class="fa fa-file-code-o"></i>Query</label>
    <input type="hidden" id="node-input-query" autofocus="autofocus"> </div>
  <div class="form-row node-text-editor-row">
    <div style="height: 300px; min-height: 150px;" class="node-text-editor" id="node-input-editor"></div>
  </div>
</script>


<script type="text/javascript">
  RED.nodes.registerType("Postgres", {
    category: "storage",
    color: '#6567a5',
    defaults: {
      name: {
        value: ""
      },
      query: {
        value: "SELECT * FROM ;"
      },
      PGConfig: {
        type: "PGConfig",
        required: true
      },
      output: {
        value: true
      },
      outputs: {
        value: 1
      }
    },
    inputs: 1,
    icon: "postgres.png",
    align: "left",
    label: function () {
      return this.name || "Postgres";
    },
    labelStyle: function () {
      return this.name ? "node_label_italic" : "";
    },
    oneditprepare: function () {
      $("#node-input-output").prop("checked", this.output);
      this.editor = RED.editor.createEditor({
        id: 'node-input-editor',
        mode: 'ace/mode/sql',
        value: $("#node-input-query").val()
      });
      this.editor.focus();
    },
    oneditsave: function () {
      $("#node-input-query").val(this.editor.getValue());
      delete this.editor;
    }
  });
</script>


<script type="text/x-red" data-help-name="Postgres">
  <p>HerokuPG is a node for running SQL queries against Postgres on Heroku </p>
  
  <p>The connection is optimised for connecting to the Heroku Postgres service where the credentials are supplied as a URL in an env var<br>
  HerokuPG sets up a console to execute queries against the configured database.</p>
  
  <h3>Details</h3>
  <p>HerokuPG implements the mustache template engine within queries queries:</p>

  <pre>
  SELECT *
  FROM table
  WHERE id = '{{ msg.id }}'
  </pre>
  <p> Alternativly you can use parameterised queries by passing in an array in <msg.params>
    <pre>
      SELECT *
      FROM table
      WHERE id = '$1'
      </pre>


      
  <h3>Output</h3>
  <p><code>msg.payload</code> will contain the result object of the query.
    <dl class="message-properties">
      <dt>command
          <span class="property-type">string</span>
      </dt>
      <dd> The sql command that was executed (e.g. "SELECT", "UPDATE", etc.) </dd>
      <dt>rowCount
          <span class="property-type">int </span>
      </dt>
      <dd> The number of rows affected by the SQL statement </dd>
      <dt>oid
          <span class="property-type">string</span>
      </dt>
      <dd> The oid returned </dd>
      <dt>updatedColumns
          <span class="property-type">int</span>
      </dt>
      <dd> rows </dd>
      <dt>updatedCells
          <span class="property-type">array</span>
      </dt>
      <dd> An array of rows returned by the command </dd>
  </dl>
  
  
</script>